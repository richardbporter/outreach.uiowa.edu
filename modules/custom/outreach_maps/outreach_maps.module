<?php
/**
 * @file
 * This module handles the applicaiton logic for the Outreach maps.
 */

/**
 * Implements template_preprocess_page().
 *
 * @param array $variables
 */
function outreach_maps_preprocess_page(&$variables) {

  // If node type is set and it is a map page.
  if (isset($variables['node']->type)) {
    if ($variables['node']->type == 'map') {

      // Add map page template suggestion hook.
      $variables['theme_hook_suggestions'][] = 'page__' . $variables['node']->type;

      // Create preprocess variables.
      $variables['map'] = $variables['node']->field_map['und']['0']['value'];

      // Get the path to the outreach_maps module.
      $path = drupal_get_path('module', 'outreach_maps');

      // Include the necessary scripts and styles.
      drupal_add_js('http://maps.google.com/maps/api/js?sensor=false', array('type' => 'external', 'group' => JS_LIBRARY, 'weight' => '90'));

      drupal_add_js($path.'/js/maplabel-compiled.js', array('weight' => '90'));

      // Adding drupal.ajax manually because it needs to run after the map scripts.
      drupal_add_js('misc/ajax.js', array('weight' => '92'));

      // County map.
      if ($variables['map'] == 'county') {
        // Include the county GeoJSON file.
        drupal_add_js($path . '/inc/shapefiles/counties.json', array('weight' => '91'));

        // Add the script to build the county map.
        drupal_add_js($path . '/js/county.jquery.js', array('weight' => '91'));
      }

      // House map.
      if ($variables['map'] == 'house') {
        // Include the county GeoJSON file.
        drupal_add_js($path . '/inc/shapefiles/iowa-house.json', array('weight' => '91'));

        // Add the script to build the county map.
        drupal_add_js($path . '/js/house.jquery.js', array('weight' => '91'));
      }

      // House map.
      if ($variables['map'] == 'senate') {
        // Include the county GeoJSON file.
        drupal_add_js($path . '/inc/shapefiles/iowa-senate.json', array('weight' => '91'));

        // Add the script to build the county map.
        drupal_add_js($path . '/js/senate.jquery.js', array('weight' => '91'));
      }

      // House map.
      if ($variables['map'] == 'congressional') {
        // Include the county GeoJSON file.
        drupal_add_js($path . '/inc/shapefiles/congress.json', array('weight' => '91'));

        // Add the script to build the county map.
        drupal_add_js($path . '/js/congressional.jquery.js', array('weight' => '91'));
      }
    }
  }
}

function outreach_maps_menu() {
   $items = array();

  // County map callback.
  $items['outreach-maps/county/%'] = array(
    'page callback' => '_outreach_maps_load_county',
    'page arguments' => array(2),
    'access callback' => 'user_access',
    'access arguments' => array('access content'),
    'type' => MENU_CALLBACK,
    'file' => 'inc/outreach_maps.admin.inc',
  );

  return $items;
}
/**
 * Implements hook_block_info().
 *
 * @return array blocks
 */
function outreach_maps_block_info() {
  $blocks['outreach_maps_county_list'] = array(
    'info' => t('County list'),
    'status' => 1,
    'region' => 'footer',
    'weight' => '99',
    'visibility' => BLOCK_VISIBILITY_NOTLISTED,
    'pages' => '<front>',
  );

  return $blocks;
}

function outreach_maps_block_view($delta = '') {
  $block = array();

  switch ($delta) {
    case 'outreach_maps_county_list':
      module_load_include('inc', 'outreach_maps', 'inc/outreach_maps.admin');
      $block['subject'] = NULL;
      $block['content']['container'] = array(
        '#attributes' => array('class' => array('container', 'l-container')),
        '#type' => 'container',
      );
      $block['content']['container']['text'] = array(
        '#markup' => '<h2>Statewide Impact</h2><p>The University of Iowa impacts the lives of Iowans from border to border and river to river. We invite you to learn more about our connections in your community. View a map of Iowa by county, house, senate or congressional district. Or select a county from the dropdown list below.',
      );
      $block['content']['container']['drop-down'] = _outreach_maps_county_list();
      break;
  }

  return $block;
}
